<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFake - MIA La Maison de l'IA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('serve_css', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('serve_image', filename='MIA_Blanc.png') }}">
</head>

<body>
    <div class="app-container">
        <!-- Header avec Logo -->
        <header class="header">
            <div class="logo-container">
                <img src="{{ url_for('serve_image', filename='MIA_Blanc.png') }}" alt="MIA - La Maison de l'IA" class="logo">
                <div>
                    <h1 class="app-title">DeepFake</h1>
                    <p class="app-subtitle">Face Swap en temps r√©el</p>
                </div>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span class="status-text" id="statusText">Pr√™t</span>
            </div>
        </header>

        <!-- Contenu Principal -->
        <main class="main-content">
            <!-- Panel Gauche - Joueurs 1-6 -->
            <aside class="panel">
                <h2 class="panel-title">S√©lection Visage</h2>
                <div class="player-grid" id="leftGrid">
                    {% for player in players_left %}
                    <div class="player-card" data-player="{{ player.id }}" tabindex="0" role="button">
                        <img src="{{ url_for('serve_face', filename=player.id + '.png') }}" 
                             alt="{{ player.name }}" 
                             class="player-avatar">
                        <p class="player-name">{{ player.name }}</p>
                    </div>
                    {% endfor %}
                </div>
            </aside>

            <!-- Centre - Cam√©ra et Contr√¥les -->
            <section class="center-panel">
                <div class="camera-container">
                    <div class="camera-feed" id="cameraFeed">
                        <img id="videoStream" alt="Video Stream" style="display: none; width: 100%; height: 100%; object-fit: contain;">
                        <div class="camera-placeholder" id="placeholder">
                            <div class="camera-placeholder-icon">üé•</div>
                            <p class="camera-placeholder-text">S√©lectionnez un visage puis cliquez sur "D√©marrer"</p>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button class="btn btn-primary" id="startBtn">
                            ‚ñ∂ D√©marrer DeepFake
                        </button>
                        <button class="btn btn-danger" id="stopBtn" disabled>
                            ‚èπ Arr√™ter
                        </button>
                    </div>
                </div>
                
                <!-- Options -->
                <div class="options-container">
                    <h3 class="options-title">Options</h3>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Mouth Mask</span>
                            <label class="toggle">
                                <input type="checkbox" id="mouthMask">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="option-item">
                            <span class="option-label">Face Enhancer</span>
                            <label class="toggle">
                                <input type="checkbox" id="faceEnhancer">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="option-item">
                            <span class="option-label">Show FPS</span>
                            <label class="toggle">
                                <input type="checkbox" id="showFps">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="option-item">
                            <span class="option-label">Many Faces</span>
                            <label class="toggle">
                                <input type="checkbox" id="manyFaces">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panel Droit - Joueurs 7-12 -->
            <aside class="panel">
                <h2 class="panel-title">S√©lection Visage</h2>
                <div class="player-grid" id="rightGrid">
                    {% for player in players_right %}
                    <div class="player-card" data-player="{{ player.id }}" tabindex="0" role="button">
                        <img src="{{ url_for('serve_face', filename=player.id + '.png') }}" 
                             alt="{{ player.name }}" 
                             class="player-avatar">
                        <p class="player-name">{{ player.name }}</p>
                    </div>
                    {% endfor %}
                </div>
            </aside>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p class="disclaimer">
                <strong>Attention</strong> : Cette application utilise la technologie de face swap.
                Son utilisation doit se faire dans le respect de la vie priv√©e et avec le consentement des personnes concern√©es.
                Projet d√©velopp√© par <strong>MIA - La Maison de l'IA</strong>.
            </p>
        </footer>
    </div>

    <script>
        // ============================================================
        // DEEPFAKE MIA - JavaScript
        // Interface Web pour Face Swap (Streaming c√¥t√© serveur)
        // ============================================================

        // -------- Configuration --------
        const API_BASE = '';
        let selectedPlayer = null;
        let isRunning = false;
        let faceLoaded = false;

        // -------- √âl√©ments DOM --------
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const videoStream = document.getElementById('videoStream');
        const placeholder = document.getElementById('placeholder');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // -------- Initialisation --------
        document.addEventListener('DOMContentLoaded', function() {
            initPlayerCards();
            initControls();
            initOptions();
        });

        // -------- Gestion des Joueurs --------
        function initPlayerCards() {
            document.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', () => selectPlayer(card));
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectPlayer(card);
                    }
                });
            });
        }

        function selectPlayer(card) {
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.player-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // S√©lectionner le nouveau joueur
            card.classList.add('selected');
            selectedPlayer = card.dataset.player;
            
            updateStatus('Chargement du visage...', 'warning');
            
            // Envoyer au serveur pour charger le visage
            fetch(`${API_BASE}/api/select_face`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player: selectedPlayer })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    faceLoaded = true;
                    console.log('Face charg√©e:', selectedPlayer);
                    updateStatus('Visage pr√™t: ' + selectedPlayer, 'success');
                } else {
                    faceLoaded = false;
                    updateStatus('Erreur: ' + data.error, 'error');
                }
            })
            .catch(err => {
                faceLoaded = false;
                console.error('Erreur:', err);
                updateStatus('Erreur de connexion', 'error');
            });
        }

        // -------- Gestion du streaming vid√©o --------
        function startVideoStream() {
            // Afficher le flux vid√©o du serveur
            videoStream.src = `${API_BASE}/video_feed?t=${Date.now()}`;
            videoStream.style.display = 'block';
            placeholder.style.display = 'none';
            
            // G√©rer les erreurs de chargement
            videoStream.onerror = function() {
                console.error('Erreur de streaming vid√©o');
                updateStatus('Erreur de streaming', 'error');
            };
        }

        function stopVideoStream() {
            videoStream.src = '';
            videoStream.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        // -------- Contr√¥les --------
        function initControls() {
            startBtn.addEventListener('click', startDeepfake);
            stopBtn.addEventListener('click', stopDeepfake);
        }

        async function startDeepfake() {
            if (!selectedPlayer) {
                updateStatus('Veuillez s√©lectionner un visage', 'warning');
                return;
            }
            
            if (!faceLoaded) {
                updateStatus('Attendez le chargement du visage', 'warning');
                return;
            }
            
            isRunning = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            updateStatus('D√©marrage...', 'warning');
            
            // D√©marrer le traitement c√¥t√© serveur
            fetch(`${API_BASE}/api/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    player: selectedPlayer,
                    options: getOptions()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('DeepFake d√©marr√©:', data);
                    updateStatus('DeepFake actif - ' + selectedPlayer, 'running');
                    // D√©marrer le streaming apr√®s que le serveur soit pr√™t
                    setTimeout(startVideoStream, 500);
                } else {
                    updateStatus('Erreur: ' + data.error, 'error');
                    isRunning = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            })
            .catch(err => {
                console.error('Erreur:', err);
                updateStatus('Erreur de connexion', 'error');
                isRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
            });
        }

        function stopDeepfake() {
            isRunning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            stopVideoStream();
            updateStatus('Arr√™t√©', 'stopped');
            
            // Arr√™ter le traitement c√¥t√© serveur
            fetch(`${API_BASE}/api/stop`, { method: 'POST' })
                .then(response => response.json())
                .then(data => console.log('DeepFake arr√™t√©:', data))
                .catch(err => console.error('Erreur:', err));
        }

        // -------- Options --------
        function initOptions() {
            const options = ['mouthMask', 'faceEnhancer', 'showFps', 'manyFaces'];
            options.forEach(opt => {
                const el = document.getElementById(opt);
                if (el) {
                    el.addEventListener('change', () => updateOption(opt, el.checked));
                }
            });
        }

        function getOptions() {
            return {
                mouthMask: document.getElementById('mouthMask')?.checked || false,
                faceEnhancer: document.getElementById('faceEnhancer')?.checked || false,
                showFps: document.getElementById('showFps')?.checked || false,
                manyFaces: document.getElementById('manyFaces')?.checked || false
            };
        }

        function updateOption(option, value) {
            fetch(`${API_BASE}/api/option`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ option, value })
            })
            .then(response => response.json())
            .then(data => console.log('Option mise √† jour:', option, value))
            .catch(err => console.error('Erreur:', err));
        }

        // -------- Status --------
        function updateStatus(message, type = 'info') {
            statusText.textContent = message;
            statusDot.classList.remove('offline');
            
            switch(type) {
                case 'error':
                    statusDot.style.background = '#f44336';
                    statusDot.classList.add('offline');
                    break;
                case 'warning':
                    statusDot.style.background = '#ff9800';
                    break;
                case 'running':
                    statusDot.style.background = '#4CAF50';
                    break;
                case 'stopped':
                    statusDot.style.background = '#9e9e9e';
                    break;
                case 'success':
                    statusDot.style.background = '#4CAF50';
                    break;
                default:
                    statusDot.style.background = '#4CAF50';
            }
        }
    </script>
</body>

</html>
